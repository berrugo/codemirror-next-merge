<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: fold_gaps.mjs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: fold_gaps.mjs</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {RangeSet} from '@codemirror/next/rangeset';
import {foldService} from '@codemirror/next/language';

/**
 * Code folding service for gaps in a ChangeSet.
 * Folds any range of at least 2 empty lines.
 * @param {ChangeSetField} changeSetField the ChangeSetField to render
 * @param {number} margin how much gap around the text
 * @returns {Extension}
 */
export function foldGaps(changeSetField, margin = 3) {
  /** @type {WeakMap&lt;ChangeSet, WeakMap&lt;Document, RangeSet&lt;boolean>>>} */
  let gapsWithMargins = new WeakMap();
  return [
    changeSetField,
    foldService.of(function(state, lineStart, lineEnd) {
      // Get the changeset and doc to compute the gaps for:
      let changeSet = state.field(changeSetField.field);
      let doc = state.doc;

      // Get the gaps:
      let gapsByDoc = gapsWithMargins.get(changeSet);
      if (gapsByDoc === undefined) {
        gapsByDoc = new WeakMap();
        gapsWithMargins.set(changeSet, gapsByDoc);
      }
      let gaps = gapsByDoc.get(doc);
      if (gaps === undefined) {
        /** @type {Array&lt;Range&lt;boolean>>} */
        let ranges = [];
        changeSet.iterGaps((posA, posB, length) => {
          // Get the first empty line:
          let firstEmptyLine = doc.lineAt(posA);
          if (posA > firstEmptyLine.from) {
            // ++firstEmptyLine
            if (firstEmptyLine.to === doc.length) return;
            firstEmptyLine = doc.lineAt(firstEmptyLine.to + 1);
          }

          // Get the last empty line:
          let lastEmptyLine = doc.lineAt(posA + length);
          if (posA + length &lt; lastEmptyLine.to) {
            // --lastEmptyLine
            if (lastEmptyLine.from === 0) return;
            lastEmptyLine = doc.lineAt(lastEmptyLine.from - 1);
          }

          // Skip `margin` lines:
          if (firstEmptyLine.from > 0) {
            for (let i = 0; i &lt; margin; ++i) {
              // ++firstEmptyLine
              if (firstEmptyLine.to === doc.length) return;
              firstEmptyLine = doc.lineAt(firstEmptyLine.to + 1);
            }
          }
          if (lastEmptyLine.to &lt; doc.length) {
            for (let i = 0; i &lt; margin; ++i) {
              // --lastEmptyLine
              if (lastEmptyLine.from === 0) return;
              lastEmptyLine = doc.lineAt(lastEmptyLine.from - 1);
            }
          }

          // Check the range is more than one line:
          if (firstEmptyLine.from >= lastEmptyLine.from) return;

          ranges.push({
            from: firstEmptyLine.from,
            to: lastEmptyLine.to,
            value: true,
          });
        });

        gaps = RangeSet.of(ranges, /*sort=*/false);
        gapsByDoc.set(doc, gaps);
      }

      // Return the gaps:
      for (let it = gaps.iter(lineStart); it.value !== null &amp;&amp; it.from &lt;= lineEnd; it.next()) {
        if (lineStart &lt;= it.from) {
          return {from: it.from, to: it.to};
        }
      }
      return null;
    }),
  ];
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ChangeSetDecorations.html">ChangeSetDecorations</a></li><li><a href="ChangeSetField.html">ChangeSetField</a></li><li><a href="TemplateGutterMarker.html">TemplateGutterMarker</a></li></ul><h3>Global</h3><ul><li><a href="global.html#acceptMarker">acceptMarker</a></li><li><a href="global.html#acceptString">acceptString</a></li><li><a href="global.html#acceptView">acceptView</a></li><li><a href="global.html#applyChunkGutter">applyChunkGutter</a></li><li><a href="global.html#diffChars">diffChars</a></li><li><a href="global.html#diffDefault">diffDefault</a></li><li><a href="global.html#diffLines">diffLines</a></li><li><a href="global.html#diffSemantic">diffSemantic</a></li><li><a href="global.html#diffToChangeSet">diffToChangeSet</a></li><li><a href="global.html#diffWords">diffWords</a></li><li><a href="global.html#foldGaps">foldGaps</a></li><li><a href="global.html#futureExtension">futureExtension</a></li><li><a href="global.html#pastExtension">pastExtension</a></li><li><a href="global.html#revertMarker">revertMarker</a></li><li><a href="global.html#revertString">revertString</a></li><li><a href="global.html#revertView">revertView</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Fri Dec 11 2020 08:34:42 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
